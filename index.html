<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potong Buah AR - Ultimate</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #videoSource {
            display: none;
        }

        /* UI Overlay - Default (Multiplayer Layout) */
        #ui-layer {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            transition: all 0.5s ease;
        }

        .player-hud {
            width: 45%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .p1-hud {
            align-items: flex-start;
            border-right: 2px dashed rgba(255, 255, 255, 0.2);
        }

        .p2-hud {
            align-items: flex-end;
            border-left: 2px dashed rgba(255, 255, 255, 0.2);
        }

        /* --- SINGLE PLAYER OVERRIDES --- */
        body.single-player-mode .p2-hud,
        body.single-player-mode .divider {
            display: none !important;
        }

        body.single-player-mode .p1-hud {
            width: 100%; /* Full width */
            border-right: none;
            align-items: center; /* Center everything */
            padding-top: 40px;
        }

        body.single-player-mode .p1-label {
            display: none; /* Hide "Player 1" label */
        }

        body.single-player-mode #p1-stats {
            justify-content: center;
        }
        /* --------------------------- */

        .player-label {
            font-size: 32px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0px rgba(0,0,0,0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .p1-label { color: #2196F3; }
        .p2-label { color: #FF9800; }

        .score-box {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
        }

        .lives-box {
            font-size: 24px;
            margin-top: 5px;
            letter-spacing: 5px;
        }

        .fruit-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            border-radius: 10px;
            max-width: 300px;
            justify-content: flex-start;
        }

        .stat-item {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .stat-item span {
            margin-left: 5px;
            color: #eee;
        }

        .game-over-text {
            color: #ff5252;
            font-size: 20px;
            display: none;
            font-weight: bold;
            margin-top: 10px;
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* Menu Screen */
        #menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            backdrop-filter: blur(8px);
        }

        h1 {
            font-size: 4rem;
            margin: 0 0 10px 0;
            background: linear-gradient(45deg, #2196F3, #FF9800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            text-align: center;
        }

        h2 {
            font-size: 1.5rem;
            color: #fff;
            margin: 0 0 40px 0;
        }

        .winner-announce {
            font-size: 3rem;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            display: none;
            text-align: center;
            max-width: 80%;
        }

        .mode-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Name Inputs Style */
        .name-inputs {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
        }
        
        input[type="text"] {
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.5);
            color: white;
            text-align: center;
            width: 250px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #2196F3;
            background: rgba(0,0,0,0.8);
        }

        button {
            padding: 20px 40px;
            font-size: 1.5rem;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 200px;
        }

        button small {
            font-size: 0.9rem;
            font-weight: normal;
            margin-top: 5px;
            opacity: 0.9;
        }

        .btn-single {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .btn-multi {
            background: linear-gradient(135deg, #2196F3, #FF9800);
        }
        
        .btn-start-game {
            background: linear-gradient(135deg, #FF5722, #FF9800);
            width: 100%;
        }

        button:hover {
            transform: scale(1.05);
            z-index: 2;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }

        .loading {
            font-size: 1rem;
            color: #aaa;
            margin-top: 25px;
            height: 20px;
        }
        
        .divider {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255,255,255,0.3);
            transform: translateX(-50%);
            z-index: 5;
        }

        #returnMenuBtn {
            margin-top: 20px;
            background: #555;
            padding: 10px 30px;
            font-size: 1rem;
            display: none; /* Hidden by default */
        }
        
        #cancelNamesBtn {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        #cancelNamesBtn:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <video id="videoSource" autoplay playsinline></video>
        <canvas id="gameCanvas"></canvas>
        
        <!-- Garis pembatas tengah (Hidden in Single Player) -->
        <div class="divider"></div>

        <!-- UI Layout -->
        <div id="ui-layer">
            <div class="player-hud p1-hud">
                <div class="player-label p1-label" id="p1-label-display">Pemain 1</div>
                <div class="score-box" id="p1-score">0</div>
                <div class="lives-box" id="p1-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                <div class="fruit-stats" id="p1-stats"></div>
                <div class="game-over-text" id="p1-status">ELIMINASI</div>
            </div>

            <!-- UI Kanan (Hidden in Single Player) -->
            <div class="player-hud p2-hud">
                <div class="player-label p2-label" id="p2-label-display">Pemain 2</div>
                <div class="score-box" id="p2-score">0</div>
                <div class="lives-box" id="p2-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                <div class="fruit-stats" id="p2-stats"></div>
                <div class="game-over-text" id="p2-status">ELIMINASI</div>
            </div>
        </div>

        <div id="menu-screen">
            <h1 id="menu-title">Ninja Buah AR</h1>
            <h2 id="menu-subtitle">Pilih Mode Permainan</h2>
            
            <div id="winner-announce" class="winner-announce"></div>

            <!-- Mode Selection Buttons -->
            <div class="mode-selection" id="mode-buttons">
                <button class="btn-single" id="btnSingle">
                    1 Pemain
                    <small>Main Sendiri</small>
                </button>
                <button class="btn-multi" id="btnMulti">
                    2 Pemain
                    <small>Split Screen</small>
                </button>
            </div>

            <!-- Name Input Form (Hidden initially) -->
            <div class="name-inputs" id="name-inputs">
                <h3 style="margin:0 0 15px 0; text-align:center;">Masukkan Nama</h3>
                <input type="text" id="input-p1-name" placeholder="Nama Pemain 1 (Kiri)" maxlength="12">
                <input type="text" id="input-p2-name" placeholder="Nama Pemain 2 (Kanan)" maxlength="12">
                <button class="btn-start-game" id="confirmNamesBtn">Mulai Pertandingan</button>
                <button id="cancelNamesBtn">Batal</button>
            </div>

            <button id="restartBtn" style="display:none; background: linear-gradient(to right, #4CAF50, #2196F3);">Main Lagi</button>
            <button id="returnMenuBtn">Kembali ke Menu</button>

            <div id="statusMsg" class="loading"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- VARIABEL & CONFIG ---
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const video = document.getElementById('videoSource');
            
            // UI Elements
            const p1ScoreEl = document.getElementById('p1-score');
            const p1LivesEl = document.getElementById('p1-lives');
            const p1StatsEl = document.getElementById('p1-stats');
            const p1StatusEl = document.getElementById('p1-status');
            const p1LabelEl = document.getElementById('p1-label-display');
            
            const p2ScoreEl = document.getElementById('p2-score');
            const p2LivesEl = document.getElementById('p2-lives');
            const p2StatsEl = document.getElementById('p2-stats');
            const p2StatusEl = document.getElementById('p2-status');
            const p2LabelEl = document.getElementById('p2-label-display');

            const menuScreen = document.getElementById('menu-screen');
            const modeButtons = document.getElementById('mode-buttons');
            const nameInputs = document.getElementById('name-inputs');
            const inputP1 = document.getElementById('input-p1-name');
            const inputP2 = document.getElementById('input-p2-name');
            
            const restartBtn = document.getElementById('restartBtn');
            const returnMenuBtn = document.getElementById('returnMenuBtn');
            const statusMsg = document.getElementById('statusMsg');
            const winnerAnnounce = document.getElementById('winner-announce');
            const menuTitle = document.getElementById('menu-title');
            const menuSubtitle = document.getElementById('menu-subtitle');

            // Game State
            let gameState = 'MENU';
            let selectedMode = 'SINGLE'; // 'SINGLE' or 'MULTI'
            let animationId;
            let spawnInterval;
            const fruitTypes = ['üçé', 'üçå', 'üçâ', 'üçç', 'ü•ù', 'üçä', 'üçá'];
            
            // Player Objects
            let p1 = { name: "Pemain 1", score: 0, lives: 3, active: true, fruitCounts: {} };
            let p2 = { name: "Pemain 2", score: 0, lives: 3, active: true, fruitCounts: {} };

            // Entities
            let fruits = [];
            let particles = [];
            let bombs = [];
            let slashes = []; // Menyimpan efek tebasan (retakan)
            let motionTrail = []; // Menyimpan jejak gerakan real-time
            
            // Motion Detection
            let prevFrameData = null;
            let motionThreshold = 25;
            let motionGridSize = 20;
            let tempCanvas = null;
            let tempCtx = null;
            let cameraActive = false;

            let w, h;

            function resize() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            // --- EVENT LISTENERS ---
            document.getElementById('btnSingle').addEventListener('click', () => {
                p1.name = "Anda";
                selectMode('SINGLE');
            });

            document.getElementById('btnMulti').addEventListener('click', () => {
                modeButtons.style.display = 'none';
                nameInputs.style.display = 'flex';
                inputP1.value = "";
                inputP2.value = "";
                inputP1.focus();
            });

            document.getElementById('cancelNamesBtn').addEventListener('click', () => {
                nameInputs.style.display = 'none';
                modeButtons.style.display = 'flex';
            });

            document.getElementById('confirmNamesBtn').addEventListener('click', () => {
                p1.name = inputP1.value.trim() || "Pemain 1";
                p2.name = inputP2.value.trim() || "Pemain 2";
                selectMode('MULTI');
            });

            restartBtn.addEventListener('click', () => startGame(selectedMode));
            returnMenuBtn.addEventListener('click', showMainMenu);

            function selectMode(mode) {
                selectedMode = mode;
                
                if (mode === 'SINGLE') {
                    document.body.classList.add('single-player-mode');
                } else {
                    document.body.classList.remove('single-player-mode');
                }

                initCamera();
            }

            // --- CAMERA SETUP ---
            async function initCamera() {
                document.getElementById('btnSingle').disabled = true;
                document.getElementById('btnMulti').disabled = true;
                document.getElementById('confirmNamesBtn').disabled = true;
                
                statusMsg.textContent = "Mengakses kamera...";
                
                if (cameraActive) {
                    startGame(selectedMode);
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });
                    
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        statusMsg.textContent = "";
                        cameraActive = true;
                        startGame(selectedMode);
                    };
                } catch (err) {
                    console.error(err);
                    statusMsg.textContent = "Gagal akses kamera.";
                    setTimeout(() => {
                        if(confirm("Kamera gagal. Main dengan Mouse?")) {
                            cameraActive = true; 
                            startGame(selectedMode); 
                        } else {
                            showMainMenu();
                        }
                    }, 500);
                }
            }

            function showMainMenu() {
                gameState = 'MENU';
                menuScreen.style.display = 'flex';
                modeButtons.style.display = 'flex';
                nameInputs.style.display = 'none'; 
                restartBtn.style.display = 'none';
                returnMenuBtn.style.display = 'none';
                winnerAnnounce.style.display = 'none';
                
                menuTitle.textContent = "Ninja Buah AR";
                menuSubtitle.textContent = "Pilih Mode Permainan";
                statusMsg.textContent = "";
                
                document.getElementById('btnSingle').disabled = false;
                document.getElementById('btnMulti').disabled = false;
                document.getElementById('confirmNamesBtn').disabled = false;
                
                p1StatusEl.style.display = 'none';
                p2StatusEl.style.display = 'none';
            }

            // --- GAME LOGIC ---

            function resetPlayer(playerObj) {
                playerObj.score = 0;
                playerObj.lives = 3;
                playerObj.active = true;
                playerObj.fruitCounts = {};
                fruitTypes.forEach(f => playerObj.fruitCounts[f] = 0);
            }

            function startGame(mode) {
                gameState = 'PLAYING';
                
                resetPlayer(p1);
                resetPlayer(p2);
                
                p1LabelEl.textContent = p1.name;
                p2LabelEl.textContent = p2.name;

                fruits = [];
                particles = [];
                bombs = [];
                slashes = [];
                motionTrail = [];
                
                updateUI();
                
                menuScreen.style.display = 'none';
                winnerAnnounce.style.display = 'none';
                p1StatusEl.style.display = 'none';
                p2StatusEl.style.display = 'none';

                if (animationId) cancelAnimationFrame(animationId);
                gameLoop();

                if (spawnInterval) clearInterval(spawnInterval);
                
                const rate = mode === 'SINGLE' ? 1000 : 800;
                spawnInterval = setInterval(() => {
                    if (gameState === 'PLAYING') spawnObject();
                }, rate); 
            }

            function gameOver() {
                gameState = 'GAMEOVER';
                clearInterval(spawnInterval);
                
                let titleText = "GAME OVER";
                let subText = "";

                if (selectedMode === 'SINGLE') {
                    titleText
