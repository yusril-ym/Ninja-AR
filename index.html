<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Potong Buah AR - Ultimate</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #videoSource {
            display: none;
        }

        /* UI Overlay - Default (Multiplayer Layout) */
        #ui-layer {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            transition: all 0.5s ease;
        }

        .player-hud {
            width: 45%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        .p1-hud {
            align-items: flex-start;
            border-right: 2px dashed rgba(255, 255, 255, 0.2);
        }

        .p2-hud {
            align-items: flex-end;
            border-left: 2px dashed rgba(255, 255, 255, 0.2);
        }

        /* --- SINGLE PLAYER OVERRIDES --- */
        body.single-player-mode .p2-hud,
        body.single-player-mode .divider {
            display: none !important;
        }

        body.single-player-mode .p1-hud {
            width: 100%; /* Full width */
            border-right: none;
            align-items: center; /* Center everything */
            padding-top: 40px;
        }

        body.single-player-mode .p1-label {
            display: none; /* Hide "Player 1" label */
        }

        body.single-player-mode #p1-stats {
            justify-content: center;
        }
        /* --------------------------- */

        .player-label {
            font-size: 32px;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0px rgba(0,0,0,0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .p1-label { color: #2196F3; }
        .p2-label { color: #FF9800; }

        .score-box {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
        }

        .lives-box {
            font-size: 24px;
            margin-top: 5px;
            letter-spacing: 5px;
        }

        .fruit-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            border-radius: 10px;
            max-width: 300px;
            justify-content: flex-start;
        }

        .stat-item {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .stat-item span {
            margin-left: 5px;
            color: #eee;
        }

        .game-over-text {
            color: #ff5252;
            font-size: 20px;
            display: none;
            font-weight: bold;
            margin-top: 10px;
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* Menu Screen */
        #menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            backdrop-filter: blur(8px);
        }

        h1 {
            font-size: 4rem;
            margin: 0 0 10px 0;
            background: linear-gradient(45deg, #2196F3, #FF9800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.5);
            text-align: center;
        }

        h2 {
            font-size: 1.5rem;
            color: #fff;
            margin: 0 0 40px 0;
        }

        .winner-announce {
            font-size: 3rem;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            display: none;
            text-align: center;
            max-width: 80%;
        }

        .mode-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Name Inputs Style */
        .name-inputs {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
        }
        
        input[type="text"] {
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.5);
            color: white;
            text-align: center;
            width: 250px;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #2196F3;
            background: rgba(0,0,0,0.8);
        }

        button {
            padding: 20px 40px;
            font-size: 1.5rem;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 200px;
        }

        button small {
            font-size: 0.9rem;
            font-weight: normal;
            margin-top: 5px;
            opacity: 0.9;
        }

        .btn-single {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
        }

        .btn-multi {
            background: linear-gradient(135deg, #2196F3, #FF9800);
        }
        
        .btn-start-game {
            background: linear-gradient(135deg, #FF5722, #FF9800);
            width: 100%;
        }

        button:hover {
            transform: scale(1.05);
            z-index: 2;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }

        .loading {
            font-size: 1rem;
            color: #aaa;
            margin-top: 25px;
            height: 20px;
        }
        
        .divider {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255,255,255,0.3);
            transform: translateX(-50%);
            z-index: 5;
        }

        #returnMenuBtn {
            margin-top: 20px;
            background: #555;
            padding: 10px 30px;
            font-size: 1rem;
            display: none; /* Hidden by default */
        }
        
        #cancelNamesBtn {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        #cancelNamesBtn:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <video id="videoSource" autoplay playsinline></video>
        <canvas id="gameCanvas"></canvas>
        
        <!-- Garis pembatas tengah (Hidden in Single Player) -->
        <div class="divider"></div>

        <!-- UI Layout -->
        <div id="ui-layer">
            <div class="player-hud p1-hud">
                <div class="player-label p1-label" id="p1-label-display">Pemain 1</div>
                <div class="score-box" id="p1-score">0</div>
                <div class="lives-box" id="p1-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                <div class="fruit-stats" id="p1-stats"></div>
                <div class="game-over-text" id="p1-status">ELIMINASI</div>
            </div>

            <!-- UI Kanan (Hidden in Single Player) -->
            <div class="player-hud p2-hud">
                <div class="player-label p2-label" id="p2-label-display">Pemain 2</div>
                <div class="score-box" id="p2-score">0</div>
                <div class="lives-box" id="p2-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                <div class="fruit-stats" id="p2-stats"></div>
                <div class="game-over-text" id="p2-status">ELIMINASI</div>
            </div>
        </div>

        <div id="menu-screen">
            <h1 id="menu-title">Ninja Buah AR</h1>
            <h2 id="menu-subtitle">Pilih Mode Permainan</h2>
            
            <div id="winner-announce" class="winner-announce"></div>

            <!-- Mode Selection Buttons -->
            <div class="mode-selection" id="mode-buttons">
                <button class="btn-single" id="btnSingle">
                    1 Pemain
                    <small>Main Sendiri</small>
                </button>
                <button class="btn-multi" id="btnMulti">
                    2 Pemain
                    <small>Split Screen</small>
                </button>
            </div>

            <!-- Name Input Form (Hidden initially) -->
            <div class="name-inputs" id="name-inputs">
                <h3 style="margin:0 0 15px 0; text-align:center;">Masukkan Nama</h3>
                <input type="text" id="input-p1-name" placeholder="Nama Pemain 1 (Kiri)" maxlength="12">
                <input type="text" id="input-p2-name" placeholder="Nama Pemain 2 (Kanan)" maxlength="12">
                <button class="btn-start-game" id="confirmNamesBtn">Mulai Pertandingan</button>
                <button id="cancelNamesBtn">Batal</button>
            </div>

            <button id="restartBtn" style="display:none; background: linear-gradient(to right, #4CAF50, #2196F3);">Main Lagi</button>
            <button id="returnMenuBtn">Kembali ke Menu</button>

            <div id="statusMsg" class="loading"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- VARIABEL & CONFIG ---
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const video = document.getElementById('videoSource');
            
            // UI Elements
            const p1ScoreEl = document.getElementById('p1-score');
            const p1LivesEl = document.getElementById('p1-lives');
            const p1StatsEl = document.getElementById('p1-stats');
            const p1StatusEl = document.getElementById('p1-status');
            const p1LabelEl = document.getElementById('p1-label-display');
            
            const p2ScoreEl = document.getElementById('p2-score');
            const p2LivesEl = document.getElementById('p2-lives');
            const p2StatsEl = document.getElementById('p2-stats');
            const p2StatusEl = document.getElementById('p2-status');
            const p2LabelEl = document.getElementById('p2-label-display');

            const menuScreen = document.getElementById('menu-screen');
            const modeButtons = document.getElementById('mode-buttons');
            const nameInputs = document.getElementById('name-inputs');
            const inputP1 = document.getElementById('input-p1-name');
            const inputP2 = document.getElementById('input-p2-name');
            
            const restartBtn = document.getElementById('restartBtn');
            const returnMenuBtn = document.getElementById('returnMenuBtn');
            const statusMsg = document.getElementById('statusMsg');
            const winnerAnnounce = document.getElementById('winner-announce');
            const menuTitle = document.getElementById('menu-title');
            const menuSubtitle = document.getElementById('menu-subtitle');

            // Game State
            let gameState = 'MENU';
            let selectedMode = 'SINGLE'; // 'SINGLE' or 'MULTI'
            let animationId;
            let spawnInterval;
            const fruitTypes = ['üçé', 'üçå', 'üçâ', 'üçç', 'ü•ù', 'üçä', 'üçá'];
            
            // Player Objects
            let p1 = { name: "Pemain 1", score: 0, lives: 3, active: true, fruitCounts: {} };
            let p2 = { name: "Pemain 2", score: 0, lives: 3, active: true, fruitCounts: {} };

            // Entities
            let fruits = [];
            let particles = [];
            let bombs = [];
            let slashes = []; // Menyimpan efek tebasan (retakan)
            let motionTrail = []; // Menyimpan jejak gerakan real-time
            
            // Motion Detection
            let prevFrameData = null;
            let motionThreshold = 25;
            let motionGridSize = 20;
            let tempCanvas = null;
            let tempCtx = null;
            let cameraActive = false;

            let w, h;

            function resize() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            // --- EVENT LISTENERS ---
            document.getElementById('btnSingle').addEventListener('click', () => {
                p1.name = "Anda";
                selectMode('SINGLE');
            });

            document.getElementById('btnMulti').addEventListener('click', () => {
                modeButtons.style.display = 'none';
                nameInputs.style.display = 'flex';
                inputP1.value = "";
                inputP2.value = "";
                inputP1.focus();
            });

            document.getElementById('cancelNamesBtn').addEventListener('click', () => {
                nameInputs.style.display = 'none';
                modeButtons.style.display = 'flex';
            });

            document.getElementById('confirmNamesBtn').addEventListener('click', () => {
                p1.name = inputP1.value.trim() || "Pemain 1";
                p2.name = inputP2.value.trim() || "Pemain 2";
                selectMode('MULTI');
            });

            restartBtn.addEventListener('click', () => startGame(selectedMode));
            returnMenuBtn.addEventListener('click', showMainMenu);

            function selectMode(mode) {
                selectedMode = mode;
                
                if (mode === 'SINGLE') {
                    document.body.classList.add('single-player-mode');
                } else {
                    document.body.classList.remove('single-player-mode');
                }

                initCamera();
            }

            // --- CAMERA SETUP ---
            async function initCamera() {
                // Disable buttons and inputs
                document.getElementById('btnSingle').disabled = true;
                document.getElementById('btnMulti').disabled = true;
                document.getElementById('confirmNamesBtn').disabled = true;
                
                statusMsg.textContent = "Mengakses kamera...";
                statusMsg.style.color = "#aaa";
                
                if (cameraActive) {
                    startGame(selectedMode);
                    return;
                }

                // Fungsi helper untuk menangani sukses
                const handleSuccess = (stream) => {
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        statusMsg.textContent = "";
                        cameraActive = true;
                        startGame(selectedMode);
                    };
                };

                // Fungsi helper untuk menangani error akhir
                const handleError = (err) => {
                    console.error("Camera Error:", err);
                    statusMsg.style.color = "#ff5252";
                    
                    // Deteksi spesifik untuk masalah Overlay/Izin
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        statusMsg.innerHTML = "‚ö†Ô∏è Akses Ditolak! Matikan <b>Quick Ball/Overlay</b> lalu coba lagi.";
                    } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                        statusMsg.textContent = "Kamera sedang digunakan aplikasi lain.";
                    } else if (err.name === 'NotFoundError') {
                        statusMsg.textContent = "Kamera tidak ditemukan.";
                    } else {
                        statusMsg.textContent = "Gagal akses kamera. Coba refresh.";
                    }

                    // Re-enable tombol agar user bisa coba lagi
                    setTimeout(() => {
                        document.getElementById('btnSingle').disabled = false;
                        document.getElementById('btnMulti').disabled = false;
                        document.getElementById('confirmNamesBtn').disabled = false;

                        // Tawarkan mode mouse sebagai cadangan
                        if(confirm("Kamera gagal diakses (Mungkin terhalang Overlay/Quick Ball). Main dengan Mouse saja?")) {
                            cameraActive = true; 
                            startGame(selectedMode); 
                        }
                    }, 1500);
                };

                try {
                    // PERCOBAAN 1: Kualitas Ideal
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    });
                    handleSuccess(stream);

                } catch (err) {
                    console.warn("Retrying camera with minimal constraints...", err);
                    
                    try {
                        // PERCOBAAN 2: Fallback ke pengaturan paling dasar (seringkali berhasil meski ada overlay ringan)
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: true, // Tanpa constraint resolusi/facing mode spesifik
                            audio: false
                        });
                        handleSuccess(stream);
                    } catch (err2) {
                        handleError(err2);
                    }
                }
            }

            function showMainMenu() {
                gameState = 'MENU';
                menuScreen.style.display = 'flex';
                modeButtons.style.display = 'flex';
                nameInputs.style.display = 'none'; 
                restartBtn.style.display = 'none';
                returnMenuBtn.style.display = 'none';
                winnerAnnounce.style.display = 'none';
                
                menuTitle.textContent = "Ninja Buah AR";
                menuSubtitle.textContent = "Pilih Mode Permainan";
                statusMsg.textContent = "";
                
                document.getElementById('btnSingle').disabled = false;
                document.getElementById('btnMulti').disabled = false;
                document.getElementById('confirmNamesBtn').disabled = false;
                
                p1StatusEl.style.display = 'none';
                p2StatusEl.style.display = 'none';
            }

            // --- GAME LOGIC ---

            function resetPlayer(playerObj) {
                playerObj.score = 0;
                playerObj.lives = 3;
                playerObj.active = true;
                playerObj.fruitCounts = {};
                fruitTypes.forEach(f => playerObj.fruitCounts[f] = 0);
            }

            function startGame(mode) {
                gameState = 'PLAYING';
                
                resetPlayer(p1);
                resetPlayer(p2);
                
                p1LabelEl.textContent = p1.name;
                p2LabelEl.textContent = p2.name;

                fruits = [];
                particles = [];
                bombs = [];
                slashes = [];
                motionTrail = [];
                
                updateUI();
                
                menuScreen.style.display = 'none';
                winnerAnnounce.style.display = 'none';
                p1StatusEl.style.display = 'none';
                p2StatusEl.style.display = 'none';

                if (animationId) cancelAnimationFrame(animationId);
                gameLoop();

                if (spawnInterval) clearInterval(spawnInterval);
                
                const rate = mode === 'SINGLE' ? 1000 : 800;
                spawnInterval = setInterval(() => {
                    if (gameState === 'PLAYING') spawnObject();
                }, rate); 
            }

            function gameOver() {
                gameState = 'GAMEOVER';
                clearInterval(spawnInterval);
                
                let titleText = "GAME OVER";
                let subText = "";

                if (selectedMode === 'SINGLE') {
                    titleText = "Permainan Selesai";
                    subText = `Skor Akhir: ${p1.score}`;
                } else {
                    if (p1.score > p2.score) {
                        titleText = `üèÜ ${p1.name} MENANG! üèÜ`;
                        subText = `${p1.name}: ${p1.score} vs ${p2.name}: ${p2.score}`;
                    } else if (p2.score > p1.score) {
                        titleText = `üèÜ ${p2.name} MENANG! üèÜ`;
                        subText = `${p2.name}: ${p2.score} vs ${p1.name}: ${p1.score}`;
                    } else {
                        titleText = "ü§ù SERI! ü§ù";
                        subText = "Skor Sama Kuat";
                    }
                }

                menuTitle.textContent = titleText;
                menuSubtitle.textContent = subText;
                
                winnerAnnounce.style.display = 'none';
                
                modeButtons.style.display = 'none';
                nameInputs.style.display = 'none';
                restartBtn.style.display = 'block';
                returnMenuBtn.style.display = 'block';
                
                menuScreen.style.display = 'flex';
            }

            function spawnObject() {
                if (selectedMode === 'SINGLE') {
                    if (!p1.active) return;
                } else {
                    if (!p1.active && !p2.active) return;
                }

                const isBomb = Math.random() < 0.2; 
                const x = Math.random() * (w - 100) + 50;
                const y = h + 50;
                let targetX;

                if (selectedMode === 'SINGLE') {
                    targetX = (w / 2) + (Math.random() - 0.5) * (w * 0.5);
                } else {
                    targetX = (x < w/2) ? w/4 : (w * 0.75);
                    targetX += (Math.random() - 0.5) * 200;
                }

                const vy = -(Math.random() * 6 + 13);
                const vx = (targetX - x) * 0.015;

                const obj = {
                    x, y, vx, vy,
                    radius: 40,
                    rotation: 0,
                    rotationSpeed: (Math.random() - 0.5) * 0.2
                };

                if (isBomb) {
                    obj.emoji = 'üí£';
                    bombs.push(obj);
                } else {
                    obj.emoji = fruitTypes[Math.floor(Math.random() * fruitTypes.length)];
                    fruits.push(obj);
                }
            }

            function createParticles(x, y, color) {
                for (let i = 0; i < 8; i++) {
                    particles.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 12,
                        vy: (Math.random() - 0.5) * 12,
                        life: 1.0,
                        color: color
                    });
                }
            }
            
            // Membuat efek garis tebasan (slash)
            function createSlash(x, y) {
                slashes.push({
                    x, y,
                    angle: Math.random() * Math.PI, // Arah acak untuk variasi visual
                    length: 80 + Math.random() * 40,
                    life: 1.0,
                    color: 'white'
                });
            }

            // --- MOTION & INTERACTION ---
            
            function processMotion() {
                ctx.save();
                ctx.translate(w, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, w, h);
                ctx.restore();

                const scaledW = Math.floor(w / motionGridSize);
                const scaledH = Math.floor(h / motionGridSize);
                
                if (!tempCanvas) {
                    tempCanvas = document.createElement('canvas');
                    tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
                }
                tempCanvas.width = scaledW;
                tempCanvas.height = scaledH;
                
                tempCtx.save();
                tempCtx.translate(scaledW, 0);
                tempCtx.scale(-1, 1);
                tempCtx.drawImage(video, 0, 0, scaledW, scaledH);
                tempCtx.restore();

                const frameData = tempCtx.getImageData(0, 0, scaledW, scaledH).data;

                if (!prevFrameData) {
                    prevFrameData = frameData;
                    return;
                }

                // Reset motion trail untuk frame ini (kita hanya gambar titik aktif saat ini)
                // Opsi lain: persistensi (trailing), tapi titik real-time lebih responsif
                motionTrail = [];

                for (let y = 0; y < scaledH; y += 2) {
                    for (let x = 0; x < scaledW; x += 2) {
                        const index = (y * scaledW + x) * 4;
                        
                        const diff = Math.abs(frameData[index] - prevFrameData[index]) +
                                     Math.abs(frameData[index+1] - prevFrameData[index+1]) +
                                     Math.abs(frameData[index+2] - prevFrameData[index+2]);
                        
                        if (diff > motionThreshold * 3) {
                            const realX = x * motionGridSize;
                            const realY = y * motionGridSize;
                            
                            // Tambahkan ke visualisasi jejak
                            motionTrail.push({x: realX, y: realY});
                            
                            handleInteraction(realX, realY);
                        }
                    }
                }
                prevFrameData = frameData;
            }

            function handleInteraction(x, y) {
                let interactor = null; 

                if (selectedMode === 'SINGLE') {
                    if (p1.active) interactor = 'P1';
                } else {
                    const isP1Zone = x < w / 2;
                    if (isP1Zone && p1.active) interactor = 'P1';
                    if (!isP1Zone && p2.active) interactor = 'P2';
                }

                if (!interactor) return;

                // --- CEK FRUITS ---
                for (let i = fruits.length - 1; i >= 0; i--) {
                    const f = fruits[i];
                    const dist = Math.hypot(x - f.x, y - f.y);
                    
                    if (dist < f.radius + 30) {
                        // Action
                        if (interactor === 'P1') {
                            p1.score += 10;
                            if(p1.fruitCounts[f.emoji] !== undefined) p1.fruitCounts[f.emoji]++;
                            createParticles(f.x, f.y, '#2196F3'); 
                        } else {
                            p2.score += 10;
                            if(p2.fruitCounts[f.emoji] !== undefined) p2.fruitCounts[f.emoji]++;
                            createParticles(f.x, f.y, '#FF9800'); 
                        }

                        // Buat efek tebasan
                        createSlash(f.x, f.y);
                        
                        fruits.splice(i, 1);
                        updateUI();
                    }
                }

                // --- CEK BOMBS ---
                for (let i = bombs.length - 1; i >= 0; i--) {
                    const b = bombs[i];
                    const dist = Math.hypot(x - b.x, y - b.y);

                    if (dist < b.radius + 30) {
                        createParticles(b.x, b.y, '#000');
                        bombs.splice(i, 1);
                        
                        if (interactor === 'P1') {
                            p1.lives--;
                            if (p1.lives <= 0) {
                                p1.active = false;
                                if (selectedMode === 'MULTI') p1StatusEl.style.display = 'block';
                            }
                        } else {
                            p2.lives--;
                            if (p2.lives <= 0) {
                                p2.active = false;
                                p2StatusEl.style.display = 'block';
                            }
                        }
                        updateUI();
                        
                        if (selectedMode === 'SINGLE' && !p1.active) {
                            gameOver();
                        } else if (selectedMode === 'MULTI' && !p1.active && !p2.active) {
                            gameOver();
                        }
                    }
                }
            }

            function updatePhysics() {
                const gravity = 0.4;

                for (let i = fruits.length - 1; i >= 0; i--) {
                    let f = fruits[i];
                    f.x += f.vx;
                    f.y += f.vy;
                    f.vy += gravity;
                    f.rotation += f.rotationSpeed;
                    if (f.y > h + 100) fruits.splice(i, 1);
                }

                for (let i = bombs.length - 1; i >= 0; i--) {
                    let b = bombs[i];
                    b.x += b.vx;
                    b.y += b.vy;
                    b.vy += gravity;
                    b.rotation += b.rotationSpeed;
                    if (b.y > h + 100) bombs.splice(i, 1);
                }

                // Update Particles
                for (let i = particles.length - 1; i >= 0; i--) {
                    let p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life -= 0.05;
                    if (p.life <= 0) particles.splice(i, 1);
                }
                
                // Update Slashes
                for (let i = slashes.length - 1; i >= 0; i--) {
                    let s = slashes[i];
                    s.life -= 0.1; // Hilang lebih cepat
                    if (s.life <= 0) slashes.splice(i, 1);
                }
            }

            function drawGame() {
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '60px Arial';

                // 1. Gambar Motion Trail (Real-time Hand Tracker)
                // Gambar sebagai partikel cahaya halus
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                // Bisa ubah warna berdasarkan pemain jika mau
                motionTrail.forEach(pt => {
                     ctx.beginPath();
                     ctx.arc(pt.x, pt.y, 8, 0, Math.PI * 2);
                     ctx.fill();
                });

                // 2. Gambar Buah
                fruits.forEach(f => {
                    ctx.save();
                    ctx.translate(f.x, f.y);
                    ctx.rotate(f.rotation);
                    ctx.fillText(f.emoji, 0, 0);
                    ctx.restore();
                });

                // 3. Gambar Bom
                bombs.forEach(b => {
                    ctx.save();
                    ctx.translate(b.x, b.y);
                    ctx.rotate(b.rotation);
                    ctx.fillText(b.emoji, 0, 0);
                    ctx.restore();
                });

                // 4. Gambar Partikel Ledakan
                particles.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.fill();
                    ctx.globalAlpha = 1.0;
                });
                
                // 5. Gambar Garis Tebasan (Slash)
                slashes.forEach(s => {
                    ctx.save();
                    ctx.translate(s.x, s.y);
                    ctx.rotate(s.angle);
                    ctx.globalAlpha = s.life;
                    
                    // Efek glow
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = 'cyan';
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(-s.length / 2, 0);
                    ctx.lineTo(s.length / 2, 0);
                    ctx.stroke();
                    
                    ctx.shadowBlur = 0;
                    ctx.globalAlpha = 1.0;
                    ctx.restore();
                });
            }

            function gameLoop() {
                if (gameState !== 'PLAYING') return;

                ctx.clearRect(0, 0, w, h);

                if (video.readyState >= 2) {
                    processMotion();
                } else {
                    ctx.fillStyle = '#222';
                    ctx.fillRect(0,0,w,h);
                }

                updatePhysics();
                drawGame();

                animationId = requestAnimationFrame(gameLoop);
            }

            // Mouse Fallback
            window.addEventListener('mousemove', (e) => {
                if (gameState === 'PLAYING') {
                    // Tambahkan ke visual trail juga jika pakai mouse
                    motionTrail.push({x: e.clientX, y: e.clientY});
                    handleInteraction(e.clientX, e.clientY);
                }
            });
            window.addEventListener('touchmove', (e) => {
                 if (gameState === 'PLAYING') {
                     motionTrail = []; // Reset manual untuk touch
                     for(let i=0; i<e.touches.length; i++) {
                         let tx = e.touches[i].clientX;
                         let ty = e.touches[i].clientY;
                         motionTrail.push({x: tx, y: ty});
                         handleInteraction(tx, ty);
                     }
                 }
            });

            function renderFruitStats(playerData, containerEl) {
                containerEl.innerHTML = '';
                fruitTypes.forEach(type => {
                    const count = playerData.fruitCounts[type] || 0;
                    if (count > 0 || selectedMode === 'SINGLE') { 
                        const item = document.createElement('div');
                        item.className = 'stat-item';
                        item.innerHTML = `${type} <span>${count}</span>`;
                        containerEl.appendChild(item);
                    }
                });
            }

            function updateUI() {
                p1ScoreEl.textContent = p1.score;
                p2ScoreEl.textContent = p2.score;
                
                const getHearts = (n) => {
                    let s = ""; 
                    for(let i=0; i<n; i++) s += "‚ù§Ô∏è"; 
                    return s || "üíÄ";
                };

                p1LivesEl.textContent = getHearts(p1.lives);
                p2LivesEl.textContent = getHearts(p2.lives);

                renderFruitStats(p1, p1StatsEl);
                if (selectedMode === 'MULTI') renderFruitStats(p2, p2StatsEl);

                if (!p1.active) p1LivesEl.style.opacity = 0.5; else p1LivesEl.style.opacity = 1;
                if (!p2.active) p2LivesEl.style.opacity = 0.5; else p2LivesEl.style.opacity = 1;
            }
        });
    </script>
</body>
</html>
